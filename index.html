<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Orange Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #E74C3C; 
            --secondary-color: #F39C12;
            --background-light: #FDFEFE; 
            --surface-light: #FFFFFF; 
            --text-primary-light: #2C3E50;
            --border-light: #EAEDED;
            
            --background-dark: #1B2631; 
            --surface-dark: #283747; 
            --text-primary-dark: #FDFEFE;
            --border-dark: #566573;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; padding-bottom: 80px; }
        
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }
        
        #app { max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; }
        .page { display: none; padding: 15px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VPN Restricted Overlay Styles (Specific Request) --- */
        #vpn-overlay {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            height: 70vh;
        }
        
        /* 1. Notice Text (Top) */
        .vpn-notice-box {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 0.95rem;
            line-height: 1.5;
            width: 100%;
            font-weight: 500;
        }

        /* 2. Image (Small & Middle) */
        .restricted-img {
            width: 80px; /* ছবি ছোট রাখা হয়েছে */
            height: 80px;
            object-fit: contain;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        /* 3. Status & Button (Bottom) */
        .vpn-status-text { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .vpn-country-tag { font-size: 0.9rem; color: #888; margin-bottom: 25px; }
        
        .retry-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white; border: none; padding: 12px 30px;
            border-radius: 25px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            display: flex; align-items: center; gap: 8px;
        }

        /* Standard Components */
        .profile-header { padding: 25px; text-align: center; border-bottom: 1px solid var(--border-light); background: var(--surface-light); }
        .dark-theme .profile-header { border-bottom-color: var(--border-dark); background: var(--surface-dark); }
        #user-photo { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--primary-color); margin-bottom: 10px; }
        
        .stat-card, .task-container, .wallet-card {
            background: var(--surface-light); border: 1px solid var(--border-light);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .dark-theme .stat-card, .dark-theme .task-container, .dark-theme .wallet-card {
            background: var(--surface-dark); border-color: var(--border-dark);
        }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { text-align: center; }
        .stat-card h3 { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .stat-card p { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }

        .task-container { display: flex; align-items: center; gap: 15px; }
        .task-icon { width: 40px; height: 40px; border-radius: 8px; }
        .btn-claim { margin-left: auto; padding: 8px 16px; border: none; background: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .btn-claim:disabled { background: #7f8c8d; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 500px;
            background: var(--surface-light); border-top: 1px solid var(--border-light);
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .dark-theme .bottom-nav { background: var(--surface-dark); border-color: var(--border-dark); }
        .nav-btn { background: none; border: none; color: #999; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn i { font-size: 1.4rem; }
        .nav-btn.active { color: var(--primary-color); }
        
        /* Helper Classes */
        .text-center { text-align: center; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background: transparent; color: inherit; margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="app-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:var(--background-light);z-index:9999;display:flex;justify-content:center;align-items:center;">
        <i class="fas fa-circle-notch fa-spin" style="font-size:40px;color:var(--primary-color);"></i>
    </div>

    <div id="app" style="display: none;">
        
        <!-- Header -->
        <header class="profile-header">
            <img id="user-photo" src="https://via.placeholder.com/70" alt="User">
            <h2 id="user-name">User</h2>
            <p>Balance: <span id="user-balance" style="color:var(--primary-color);font-weight:bold;">0.00</span> TK</p>
        </header>

        <main>
            <!-- 1. Home Page -->
            <div id="home-page" class="page active">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Referrals</h3><p id="ref-count">0</p></div>
                    <div class="stat-card"><h3>Ads Watched</h3><p id="ad-count">0</p></div>
                    <div class="stat-card"><h3>Total Earned</h3><p id="total-earned">0.00</p></div>
                    <div class="stat-card"><h3>Earning Wallet</h3><p id="earning-wallet">0.00</p></div>
                </div>
                <!-- Dynamic Links (If any) -->
                <div id="home-links"></div>
            </div>

            <!-- 2. Tasks Page (Only Ads + VPN Logic) -->
            <div id="tasks-page" class="page">
                
                <!-- Restricted Overlay (Default Hidden) -->
                <div id="vpn-overlay">
                    <!-- Notice at TOP -->
                    <div class="vpn-notice-box" id="vpn-notice-text">
                        Loading Notice...
                    </div>
                    
                    <!-- Image SMALL -->
                    <!-- আপনি এখানে আপনার নিজস্ব ছবির লিংক দিন। আমি একটি ডেমো আইকন ব্যবহার করছি -->
                    <img src="https://img.icons8.com/color/96/access-denied.png" class="restricted-img" alt="Restricted">
                    
                    <!-- Status Text -->
                    <div class="vpn-status-text">Access Restricted</div>
                    <div class="vpn-country-tag">Allowed: <span id="allowed-country-name">...</span></div>
                    
                    <!-- Retry Button -->
                    <button class="retry-btn" onclick="checkVPNAndRender()">
                        <i class="fas fa-sync-alt"></i> Retry Connection
                    </button>
                </div>

                <!-- Main Task Content (Hidden if Restricted) -->
                <div id="task-content" style="display:none;">
                    <div class="wallet-card text-center">
                        <h3 style="opacity:0.7;">Earning Wallet</h3>
                        <h1 style="color:var(--primary-color); margin:10px 0;"><span id="task-wallet-bal">0.00</span> TK</h1>
                        <p style="font-size:0.8rem; margin-bottom:10px;">Minimum 100 TK to move to Main Balance</p>
                        <button id="move-bal-btn" class="btn-claim" style="width:100%; padding:12px;" disabled>Move to Balance</button>
                    </div>

                    <div style="margin-top:20px;">
                        <h3 style="margin-bottom:10px;">Daily Tasks</h3>
                        <!-- Ad Progress -->
                        <div style="background:#ddd;height:8px;border-radius:4px;margin-bottom:15px;overflow:hidden;">
                            <div id="ad-progress-bar" style="width:0%;height:100%;background:var(--primary-color);transition:0.3s;"></div>
                        </div>
                        
                        <!-- Watch Button -->
                        <div class="task-container">
                            <img src="https://img.icons8.com/fluency/48/play-button.png" class="task-icon">
                            <div>
                                <h4>Watch Video Ad</h4>
                                <p style="font-size:0.8rem; opacity:0.7;">Earn TK per ad</p>
                            </div>
                            <button id="watch-ad-btn" class="btn-claim">Watch</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Bonus Page (Static Tasks) -->
            <div id="bonus-page" class="page">
                <h3 style="margin-bottom:15px;">Bonus Tasks</h3>
                <div id="bonus-list"></div>
            </div>

            <!-- 4. Leaderboard -->
            <div id="leaderboard-page" class="page">
                <h3 style="margin-bottom:15px;">Top Referrers</h3>
                <div id="leaderboard-list"></div>
            </div>

            <!-- 5. Profile / Withdraw -->
            <div id="profile-page" class="page">
                
                <!-- Invite Section -->
                <div class="wallet-card text-center">
                    <h3>Invite & Earn</h3>
                    <p style="font-size:0.9rem; margin:10px 0;">Share your link and earn bonus.</p>
                    <input type="text" id="ref-link" readonly style="text-align:center; font-size:0.8rem;">
                    <button class="btn-claim" style="width:100%;" onclick="copyRef()">Copy Link</button>
                </div>

                <!-- Withdraw Form -->
                <div class="wallet-card">
                    <h3>Withdraw Funds</h3>
                    <p id="withdraw-notice" style="font-size:0.8rem; color:red; margin-bottom:10px;"></p>
                    <form id="withdraw-form">
                        <select id="w-method" required></select>
                        <input type="text" id="w-acc" placeholder="Account Number" required>
                        <input type="number" id="w-amt" placeholder="Amount" required>
                        <button type="submit" class="btn-claim" style="width:100%; padding:12px;">Request Withdraw</button>
                    </form>
                </div>

                <!-- History -->
                <div style="margin-top:20px;">
                    <h3>History</h3>
                    <div id="history-list"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="nav('home-page', this)"><i class="fas fa-home"></i>Home</button>
            <button class="nav-btn" onclick="nav('tasks-page', this)"><i class="fas fa-play-circle"></i>Tasks</button>
            <button class="nav-btn" onclick="nav('bonus-page', this)"><i class="fas fa-gift"></i>Bonus</button>
            <button class="nav-btn" onclick="nav('leaderboard-page', this)"><i class="fas fa-trophy"></i>Top</button>
            <button class="nav-btn" onclick="nav('profile-page', this)"><i class="fas fa-user"></i>Profile</button>
        </nav>

    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Theme Handling
        if(tg.colorScheme === 'dark') document.body.classList.add('dark-theme');
        else document.body.classList.add('light-theme');

        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyDJPs6pXv2k_wTCNWHqsr5exFkvOMeIX40",
          authDomain: "orange-leamon-bot.firebaseapp.com",
          databaseURL: "https://orange-leamon-bot-default-rtdb.firebaseio.com",
          projectId: "orange-leamon-bot",
          storageBucket: "orange-leamon-bot.firebasestorage.app",
          messagingSenderId: "440970951072",
          appId: "1:440970951072:web:6cf46f7720d260047c4cc5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State Variables
        let user = tg.initDataUnsafe.user || { id: 123456, first_name: 'Test', username: 'user' }; // Fallback for browser test
        let config = {};
        let userData = {};
        let earningBalance = parseFloat(localStorage.getItem('earnBal') || 0);

        // --- Initialization ---
        const init = async () => {
            // 1. Get Config
            const confSnap = await db.ref('config').once('value');
            config = confSnap.val() || {};
            
            // 2. Load Ad SDK
            if(config.adZoneId) {
                const s = document.createElement('script');
                s.src = '//libtl.com/sdk.js';
                s.dataset.zone = config.adZoneId;
                s.dataset.sdk = `show_${config.adZoneId}`;
                document.body.appendChild(s);
            }

            // 3. Get/Create User
            const uRef = db.ref(`users/${user.id}`);
            const uSnap = await uRef.once('value');
            if(!uSnap.exists()) {
                const startParam = tg.initDataUnsafe.start_param;
                await uRef.set({
                    id: user.id, firstName: user.first_name, username: user.username,
                    balance: 0, referrals: 0, totalEarned: 0, dailyAds: 0, 
                    date: new Date().toDateString(), referredBy: startParam || null
                });
                // Referral Bonus Logic (Optional - Simplified)
                if(startParam && startParam != user.id) {
                    await db.ref(`users/${startParam}/referrals`).set(firebase.database.ServerValue.increment(1));
                    await db.ref(`users/${startParam}/balance`).set(firebase.database.ServerValue.increment(config.referralBonus || 0));
                }
            }
            // Daily Reset Logic
            userData = (await uRef.once('value')).val();
            if(userData.date !== new Date().toDateString()) {
                await uRef.update({ dailyAds: 0, date: new Date().toDateString() });
                userData.dailyAds = 0;
            }

            renderUI();
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        };

        // --- UI Rendering ---
        const renderUI = () => {
            // Header
            document.getElementById('user-name').innerText = userData.firstName;
            document.getElementById('user-balance').innerText = (userData.balance||0).toFixed(2);
            document.getElementById('user-photo').src = user.photo_url || 'https://via.placeholder.com/70';

            // Home Stats
            document.getElementById('ref-count').innerText = userData.referrals || 0;
            document.getElementById('ad-count').innerText = userData.dailyAds || 0;
            document.getElementById('total-earned').innerText = (userData.totalEarned || 0).toFixed(2);
            document.getElementById('earning-wallet').innerText = earningBalance.toFixed(2);
            document.getElementById('task-wallet-bal').innerText = earningBalance.toFixed(2);
            
            // Ref Link
            document.getElementById('ref-link').value = `https://t.me/${config.botUsername}/app?startapp=${user.id}`;

            // Buttons State
            document.getElementById('move-bal-btn').disabled = earningBalance < 100;
            
            // Render Tasks Lists
            renderBonusTasks();
            renderLeaderboard();
            renderWithdrawOptions();
            renderHistory();
        };

        // --- VPN & Country Check Logic (Crucial) ---
        window.checkVPNAndRender = async () => {
            const overlay = document.getElementById('vpn-overlay');
            const content = document.getElementById('task-content');
            
            // Set Loading State
            overlay.style.display = 'flex';
            content.style.display = 'none';
            document.getElementById('vpn-notice-text').innerText = "Checking connection...";
            
            // 1. Is VPN Required?
            if(!config.vpnRequired) {
                overlay.style.display = 'none';
                content.style.display = 'block';
                return;
            }

            // 2. Fetch User IP
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                const userCountry = data.country_name || "";
                
                const allowed = config.allowedCountry || "United States";
                
                // 3. Update UI Elements
                document.getElementById('allowed-country-name').innerText = allowed;
                document.getElementById('vpn-notice-text').innerText = config.taskPageNotice || "Please connect to VPN.";

                // 4. Compare
                if(userCountry.toLowerCase().includes(allowed.toLowerCase())) {
                    // Success
                    overlay.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    // Failed - Show Restricted UI
                    overlay.style.display = 'flex';
                    content.style.display = 'none';
                }

            } catch(e) {
                console.error("IP Check Error", e);
                // On error, show restriction to be safe, or allow (Admin choice usually).
                // Here showing restricted with error msg.
                document.getElementById('vpn-notice-text').innerText = "Connection check failed. Please check internet.";
            }
        };

        // --- Actions ---
        
        // 1. Navigation
        window.nav = (pageId, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            btn.classList.add('active');

            if(pageId === 'tasks-page') {
                checkVPNAndRender(); // Trigger Check
            }
        };

        // 2. Watch Ad
        document.getElementById('watch-ad-btn').addEventListener('click', async () => {
            const limit = config.dailyAdLimit || 10;
            if((userData.dailyAds || 0) >= limit) return tg.showAlert("Daily limit reached!");

            const adFn = window['show_' + config.adZoneId];
            if(typeof adFn !== 'function') return tg.showAlert("Ad loading...");

            try {
                await adFn();
                // Success
                const reward = config.adValue || 0;
                earningBalance += reward;
                localStorage.setItem('earnBal', earningBalance);
                
                userData.dailyAds++;
                userData.totalEarned = (userData.totalEarned || 0) + reward;
                
                // Update DB
                await db.ref(`users/${user.id}`).update({
                    dailyAds: userData.dailyAds,
                    totalEarned: userData.totalEarned
                });

                tg.showAlert(`+${reward} TK Added to Earning Wallet!`);
                renderUI();
                
                // Update Progress Bar
                const pct = (userData.dailyAds / limit) * 100;
                document.getElementById('ad-progress-bar').style.width = pct + '%';

            } catch(e) { tg.showAlert("Ad failed/closed."); }
        });

        // 3. Move Balance
        document.getElementById('move-bal-btn').addEventListener('click', async () => {
            if(earningBalance < 100) return;
            await db.ref(`users/${user.id}/balance`).set(firebase.database.ServerValue.increment(earningBalance));
            userData.balance += earningBalance;
            earningBalance = 0;
            localStorage.setItem('earnBal', 0);
            renderUI();
            tg.showAlert("Balance Moved Successfully!");
        });

        // 4. Bonus Tasks Render
        const renderBonusTasks = () => {
            const list = document.getElementById('bonus-list');
            list.innerHTML = '';
            if(!config.tasks) return;
            
            Object.entries(config.tasks).forEach(([key, t]) => {
                const isDone = userData.tasks && userData.tasks[key];
                const item = document.createElement('div');
                item.className = 'task-container';
                item.innerHTML = `
                    <img src="${t.icon}" class="task-icon">
                    <div style="flex:1">
                        <h4>${t.name}</h4>
                        <p style="font-size:0.8rem;color:var(--primary-color);">+${t.reward} TK</p>
                    </div>
                    <button class="btn-claim" ${isDone ? 'disabled' : ''} onclick="doTask('${key}', '${t.url}', ${t.reward})">
                        ${isDone ? 'Done' : 'Start'}
                    </button>
                `;
                list.appendChild(item);
            });
        };

        window.doTask = (key, url, reward) => {
            tg.openLink(url);
            setTimeout(async () => {
                if(confirm("Did you complete the task?")) {
                     await db.ref(`users/${user.id}/balance`).set(firebase.database.ServerValue.increment(reward));
                     await db.ref(`users/${user.id}/tasks/${key}`).set(true);
                     if(!userData.tasks) userData.tasks = {};
                     userData.tasks[key] = true;
                     userData.balance += reward;
                     renderUI();
                }
            }, 5000);
        };

        // 5. Leaderboard
        const renderLeaderboard = async () => {
            const snap = await db.ref('users').orderByChild('referrals').limitToLast(10).once('value');
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            const arr = [];
            snap.forEach(c => arr.push(c.val()));
            arr.reverse().forEach((u, i) => {
                list.innerHTML += `<div class="task-container" style="padding:10px;">
                    <b>#${i+1}</b>
                    <span style="margin-left:10px; flex:1;">${u.firstName}</span>
                    <span style="color:var(--primary-color); font-weight:bold;">${u.referrals} Refs</span>
                </div>`;
            });
        };

        // 6. Withdraw
        const renderWithdrawOptions = () => {
            const sel = document.getElementById('w-method');
            sel.innerHTML = '<option value="">Select Method</option>';
            if(config.withdrawMethods) {
                config.withdrawMethods.forEach(m => {
                    sel.innerHTML += `<option value="${m.name}">${m.name} (Min: ${m.min})</option>`;
                });
            }
            if(config.minimumWithdrawReferrals > 0) {
                document.getElementById('withdraw-notice').innerText = `Requirement: ${config.minimumWithdrawReferrals} Referrals to withdraw.`;
            }
        };

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Ref Check
            if((userData.referrals||0) < (config.minimumWithdrawReferrals||0)) 
                return tg.showAlert(`You need ${config.minimumWithdrawReferrals} referrals!`);
            
            const amt = parseFloat(document.getElementById('w-amt').value);
            if(amt > userData.balance) return tg.showAlert("Insufficient Balance");
            
            // Method check (find min)
            const method = document.getElementById('w-method').value;
            const mObj = config.withdrawMethods.find(m => m.name === method);
            if(amt < mObj.min) return tg.showAlert(`Minimum withdrawal is ${mObj.min}`);

            // Push
            await db.ref('withdrawals/pending').push({
                userId: user.id,
                userName: user.first_name,
                method: method,
                account: document.getElementById('w-acc').value,
                amount: amt,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            await db.ref(`users/${user.id}/balance`).set(firebase.database.ServerValue.increment(-amt));
            userData.balance -= amt;
            renderUI();
            tg.showAlert("Withdrawal Request Submitted!");
            document.getElementById('withdraw-form').reset();
        });

        const renderHistory = () => {
            // Simplified loading of last 5 items to save bandwidth/code
            db.ref('withdrawals/pending').orderByChild('userId').equalTo(user.id).limitToLast(5).on('value', s => {
                const div = document.getElementById('history-list');
                div.innerHTML = '';
                s.forEach(c => {
                    const d = c.val();
                    div.innerHTML += `<div class="task-container" style="font-size:0.85rem;">
                        <div>${d.method}<br><small>${new Date(d.timestamp).toLocaleDateString()}</small></div>
                        <div style="margin-left:auto;text-align:right;">${d.amount} TK<br><span style="color:orange;">Pending</span></div>
                    </div>`;
                });
            });
        };

        window.copyRef = () => {
            navigator.clipboard.writeText(document.getElementById('ref-link').value);
            tg.showAlert("Link Copied!");
        };

        // Start App
        init();

    </script>
</body>
</html>
